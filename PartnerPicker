<!doctype html>
<html>
  <head>
    <style>
      body {
        font-family: system-ui, Arial, sans-serif;
        padding: 16px;
        color: #111;
      }
      
      .spinner {
        display: none;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #1a73e8;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-left: 8px;
        vertical-align: middle;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .status {
        margin-top: 12px;
        padding: 8px;
        border-radius: 4px;
        display: none;
        font-size: 13px;
      }
      
      .status.success {
        background: #e6f4ea;
        color: #137333;
        border: 1px solid #81c995;
      }
    </style>
  </head>
  <body>
    <label style="display:block; margin-bottom:8px; font-weight:500;">
      Wybierz partnera
    </label>
    
    <select id="partner" style="width:100%; padding:8px; margin-bottom:12px; font-size:14px;">
      <option value="" disabled selected>— wybierz —</option>
      <? for (var i=0; i<ids.length; i++) { ?>
        <option value="<?= ids[i] ?>"><?= ids[i] ?></option>
      <? } ?>
    </select>
    
    <div style="display:flex; align-items:center;">
      <button id="submitBtn" onclick="save()" style="padding:8px 16px; font-size:14px; cursor:pointer;">
        Ustaw
      </button>
      <div id="spinner" class="spinner"></div>
    </div>
    
    <div id="status" class="status"></div>

    <script>
      function save() {
        var id = document.getElementById('partner').value;
        if (!id) {
          alert('Wybierz partnera z listy.');
          return;
        }
        
        // 1. Zablokuj przycisk
        var btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.textContent = 'Ustawiam...';
        btn.style.opacity = '0.6';
        btn.style.cursor = 'not-allowed';
        
        // 2. Pokaż spinner
        document.getElementById('spinner').style.display = 'inline-block';
        
        // 3. Wywołaj funkcję
        google.script.run
          .withSuccessHandler(onSuccess)
          .withFailureHandler(onFailure)
          .setActivePartner(id);
      }
      
      function onSuccess() {
        // Ukryj spinner
        document.getElementById('spinner').style.display = 'none';
        
        // Pokaż komunikat sukcesu
        var status = document.getElementById('status');
        status.textContent = '✓ Partner ustawiony pomyślnie!';
        status.className = 'status success';
        status.style.display = 'block';
        
        // Zamknij okno po 1 sekundzie (żeby user zobaczył komunikat)
        setTimeout(function() {
          google.script.host.close();
        }, 1000);
      }
      
      function onFailure(err) {
        // Ukryj spinner
        document.getElementById('spinner').style.display = 'none';
        
        // Przywróć przycisk
        var btn = document.getElementById('submitBtn');
        btn.disabled = false;
        btn.textContent = 'Ustaw';
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
        
        // Pokaż błąd
        alert('Błąd ustawiania partnera:\n' + (err && err.message ? err.message : err));
      }
    </script>
  </body>
</html>
